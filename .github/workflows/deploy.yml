name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Build and Test
  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate Prisma Client
      run: npx prisma generate

    - name: Run linting
      run: npm run lint

    - name: Run type check
      run: npx tsc --noEmit

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production

  # Deploy to VPS
  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          set -e  # Exit on error
          
          echo "=== Starting Deployment ==="
          
          # Navigate to project directory
          cd /var/www/survey-web || { echo "Directory not found, creating..."; sudo mkdir -p /var/www/survey-web; sudo chown ubuntu:ubuntu /var/www/survey-web; cd /var/www/survey-web; }
          
          # Pull latest code
          # Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          # Step 1: Backup database (if containers are running)
          echo "ğŸ“¦ Step 1: Creating database backup..."
          if docker compose -f docker-compose.prod.yml ps | grep -q postgres; then
            BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
            docker compose -f docker-compose.prod.yml exec -T postgres pg_dump -U postgres survey_database > "$BACKUP_FILE" || echo "âš ï¸  Backup skipped (database might not be running)"
            echo "âœ… Backup saved to: $BACKUP_FILE"
          else
            echo "âš ï¸  Database not running, skipping backup"
          fi
          
          # Step 2: Ensure database is running for migration
          echo "ğŸ”„ Step 2: Ensuring database is running..."
          docker compose -f docker-compose.prod.yml up -d postgres
          
          # Wait for database to be ready
          echo "â³ Waiting for database to be ready..."
          sleep 10
          until docker compose -f docker-compose.prod.yml exec -T postgres pg_isready -U postgres > /dev/null 2>&1; do
            echo "   Waiting for database..."
            sleep 2
          done
          echo "âœ… Database is ready"
          
          # Step 3: Apply database migrations
          echo "ğŸ”„ Step 3: Applying database migrations..."
          docker compose -f docker-compose.prod.yml run --rm app npx prisma migrate deploy || {
            echo "âš ï¸  Migration failed or already applied, continuing..."
          }
          
          # Step 4: Generate Prisma Client
          echo "ğŸ”§ Step 4: Generating Prisma client..."
          docker compose -f docker-compose.prod.yml run --rm app npx prisma generate
          
          # Step 5: Ensure JSON file exists for backfill
          echo "ğŸ“„ Step 5: Checking JSON file for backfill..."
          if [ ! -f "jenis_data_dan_threats_with_explanations.json" ]; then
            echo "âš ï¸  JSON file not found, skipping backfill"
          else
            # Step 6: Run backfill script
            echo "ğŸ”„ Step 6: Running backfill script..."
            docker compose -f docker-compose.prod.yml run --rm app npm run backfill:explanations || {
              echo "âš ï¸  Backfill failed or no data to backfill, continuing..."
            }
          fi
          
          # Step 7: Stop existing containers and FORCE REMOVE by name
          echo "ğŸ›‘ Step 7: Stopping and removing existing containers..."
          docker compose -f docker-compose.prod.yml down || true
          docker rm -f survey-app survey-postgres || true
          
          # Remove old images to save space
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f || true
          
          # Step 8: Build and start services with production config
          echo "ğŸš€ Step 8: Building and starting services..."
          docker compose -f docker-compose.prod.yml up --build --no-cache -d
          
          # Step 9: Wait for services to be healthy
          echo "â³ Step 9: Waiting for services to start..."
          sleep 30
          
          # Wait for app to be ready
          echo "â³ Waiting for application to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Application is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âš ï¸  Application health check timeout, but continuing..."
            else
              echo "   Attempt $i/30..."
              sleep 2
            fi
          done
          
          # Show running containers
          echo ""
          echo "ğŸ“Š Container Status:"
          docker compose -f docker-compose.prod.yml ps
          
          echo ""
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Application available at: http://43.173.30.94:3000"
